/**
 * EdgeOne Pages Functions - 随机图片接口
 * 捕获所有路径的处理器：functions/[[path]].js
 *
 * 支持的接口：
 *   GET /random        → 302 重定向到随机图片
 *   GET /random/json   → 返回随机图片的 JSON 信息
 *   GET /list          → 返回全部图片列表
 */

// /img 目录下的全部图片（新增图片后需同步更新此列表）
const IMAGES = [
  '00F7BFD9C469593116E4CEC98B974338.png',
  '022FFE29C27A0E683CE40B7881A52119.png',
  '0243A68A9649ADA64CD54985411CC076.png',
  '033C6441B087DB780DFE05013F6995EA.png',
  '0723122B8021B41101053066A2F420AE.jpg',
  '0F20FA99E8EC655EBBFC513BCE7B328F.jpg',
  '1017638C35AC81902B4EC11182693394.jpg',
  '1166874F19A6E6CE505720D127C7D4FB.jpg',
  '139D24A85205D50800FFA0D7855F0FC6.jpg',
  '149E79EC0CE0E37A9B32710071AA8D40.jpg',
  '185BA4E7D62FF5D16332909855360972.png',
  '18838BA90B8A5A1C9BAC0065D37C7B49.jpg',
  '1981AE34EBB04405112F64D70D9CC854.jpg',
  '199F8C2BE6924F5D4BE7117AB7FA9F92.png',
  '1A5A0F91E3557E6867D5872845818A22.jpg',
  '1B1261F5A390DE1163FCF002E30145C1.jpg',
  '1BDA16A13FE6497AF2021D738CA0BE5E.jpg',
  '1CCCA0EC57C8EABFAE72A8E8722F6814.jpg',
  '1E7627BA95EE11DEE69915044DFEC2C4.png',
  '21A45E6BE840DC94BFE560CE698C9DB5.png',
  '245F9801DA5B27D4D5835CE9C7477D52.jpg',
  '28AE087A6F33933EB8E3C973F6260865.png',
  '29C6D768D497EE68F8EAA60D47094EC5.jpg',
  '29E8E53F821D05BA543653898FF4322D.jpg',
  '2C6141AEB3AEA307C491FF13F8ABB220.jpg',
  '2E024447D5D09FE7D85959DA1EDA0049.jpg',
  '2F13D77177B468F15920CA24D198E10D.png',
  '2F66C52F50B82F68229C30B7E3F1AE6C.jpg',
  '3107C17E5A15880890E9ABCEBEA9A33D.png',
  '315527C23FADA105E55224060976F785.jpg',
  '337D4B076BDE98CB31F24ADC7CB9E68F.jpg',
  '33C080D95A2B853DC2EE6888EA035895.png',
  '35070F8E9E36F8F2E0383A9C67487609.jpg',
  '39DFAFC37D22FB4E9C789D2BC69C07CE.jpg',
  '3C96EE14148B7A88E0726889EF51E567.jpg',
  '3DB98DB510FCA54B6C0697AF14F096BB.png',
  '3E1B8CBD2326C3CCA17F62D34E381D25.jpg',
  '3F3CBD6C83F519256D453558345196B0.jpg',
  '3F6425877AFCD9FE9B26140E540321CB.jpg',
  '3FB9F7FE79FFFD07FC65F4B31DD71667.png',
  '40DDAC3C067BA9E3F0FBC7D5BE536ECA.jpg',
  '431CD2580D32CF361428F8F193BC20F4.jpg',
  '455D711C509102597B4B44824A380886.png',
  '4D0F804F7F6CD31FC01C04E1EEB4E059.jpg',
  '4F5099BCB34445103F4695FC304388C3.jpg',
  '4F7259A9ADE42F90C8EC7AC37C60AA24.jpg',
  '53984543C02597CC8A6E564D30CD70DD.jpg',
  '54074DCFC728727C894E97CE7417A694.png',
  '54A02F98FF8C19A7D03857232F9EDD71.jpg',
  '56FC81DBDD90C7D29CCFACAD5F64D6C0.jpg',
  '585712DCC5663CE3EAD82EE85FA4DA33.png',
  '5C954079B45321AFDB5D3728563EC672.jpg',
  '5D5BCE0780BA405DC0B7A016A02C7CD3.jpg',
  '5DA18C068B9A513A52A6B0858E28B0EB.jpg',
  '5DDA00FB761467A16A1AE5C9E921AC89.jpg',
  '60A72628EA93277233A54D062950CDC8.jpg',
  '60DEA93D00CD11542783F0BCB026933E.jpg',
  '613EC359DD36C20AE04043727C7E88AF.jpg',
  '676BB00C467EF14B9B511CDC9AEE0A81.jpg',
  '67E99B6E84F866F26F6267BF75203F5F.png',
  '692CE492867689536FF40AD54D9F92CE.png',
  '69CAE320C42F286E81E3A47F12FD59F8.jpg',
  '69F1BA80E741FC0F299DF7914CABD306.jpg',
  '6ABE26F8846992802A6A7E88D961B61E.jpg',
  '6B2EC0C07CF4A15D78A770AA92A5875B.jpg',
  '6BB1B09F5125E29E399679502D5DA72B.jpg',
  '6CB29E4239CED92682C518E798E6F93C.png',
  '6EEC3C9DDA2ADBA4EF26A38EC7508117.jpg',
  '7429B79328E1CE9619AD95EBA0E3A70C.png',
  '7486CC5E9AD56F056DF995E7F3FB108E.png',
  '7519C9F112E7CE34A0DD632F4694D780.jpg',
  '75ACEC38F04623EF90DE2E9EAC46BE2F.jpg',
  '78898FA0E14B5F77D7FB4980FBD5498D.png',
  '78B90A8E370026975AC5462512730F34.jpg',
  '793C9AC71A91838E960521791941201B.jpg',
  '7AEFBFEF5D55EB1AA21720AE156CAD94.png',
  '7C53CBC763485D1AEFF9F2A941A31F73.jpg',
  '7CA26C826F4EC846C2ACB108B066A616.jpg',
  '7D3ECE26D2FD500F3A492E81EEF82739.jpg',
  '7D80991B3E709C33A668FDF5E07F668A.png',
  '7DB51550DB185E36A4DF197DD4814351.jpg',
  '7F2C19AC902BCB08603B0CDA7E705D5D.jpg',
  '8110FF7B883ECB28659DE1F60D866474.jpg',
  '85B428DF9DA000C5743DFD6FA382A4B3.jpg',
  '85B8A57B15663E731B0C6DC09EA8DADF.png',
  '87440DF4E996742472188691AB8F608F.jpg',
  '874FD338E73AC2D645C77ABAFB5774D3.jpg',
  '8852fa8f20eed32db61f3745af1a177d.png',
  '8B6BB5960187900E711C7745B1B58D75.jpg',
  '8E96B841B2C3F28A949D9645016C1DF5.jpg',
  '908B810A0DB83E3BEAE084031361F4CC.jpg',
  '90BD4AA0DBCB90AEDA0B9098852ED6DA.jpg',
  '911F6C680E348177CD397EC8DD5E882E.png',
  '944152BAE8D3415AEB880F9B6783146D.png',
  '9957F8D7AD6FB0341D91BFAA1664FB44.jpg',
  '99CF38B315816CA4437EEA34BAFD13C6.jpg',
  '9A084D6CB13246BCFBB489ED5E00AEBC.png',
  '9AD8BCDB6C2C116378CF042CA7EA52C4.jpg',
  '9E7188C281A205226F0E5A455209EC9D.jpg',
  'A074D776C274947520CADC92F61B8CF7.jpg',
  'A13D0AFA2D4F546F402EDE07D8088085.jpg',
  'A152C75196F5A4FD48F90F14AE1EF8A8.jpg',
  'A250E420C2B6D29F0FBEB3953BC3CA82.png',
  'A321F33622FEC1EE11C279BAF271B1F7.jpg',
  'A612B1EF99C48F30C0A47403A73D86A2.jpg',
  'A7CEF1773681C2A813176F0C9F6F339F.png',
  'A7DC7A7002AD895445218F1E1D6D0293.png',
  'A867DEA2B7065B42FDC837B6B8A5B29A.png',
  'AC9B91E464D9C68FC4B3EA2F4EA2270A.png',
  'ACE50E0BCEE91AC633A126FB7197E668.jpg',
  'AD98FDCE3BD49C16B48583055179C12B.jpg',
  'B06C6AEA13ED7644CB71A00D6ABEF6B7.jpg',
  'B2653A564096D35397BC367F3A15A7B4.jpg',
  'B2E9E54886EA768C0E1C867FFFBFC89F.jpg',
  'B3607C9E65EB33F13D2C8B9F72D79F91.jpg',
  'B9D0ADFFE9FFC88C9AA52872187E4AAC.jpg',
  'BA04854EFFB30F45EB56929AC588FEB2.jpg',
  'BA2A81818C69666FAB837997D7AB6D1D.jpg',
  'BA62FF6A08B4C914DFF21C0C7B7677C2.jpg',
  'BF88C891360248EFEE4C1B604419018F.jpg',
  'C4DCFD058B3BA37FB6EFD12FD046B759.jpg',
  'C5D3D9317BEE256595EE7A8468D326E6.jpg',
  'C6DBC7C2EF6192E2C1DF095CD83FC924.jpg',
  'CA348E44462A652C17706D91FFC49A8C.jpg',
  'CAB08D20C828B6CEB62295538104140E.png',
  'CBD3E4F97472591F6C341FA3E821D9F6.jpg',
  'CD0322B77F4E3F2E81145A9BDF465B4A.jpg',
  'D189CD05A7A26D250D535E6EFB73EE13.png',
  'D33EE3CBE1ABCC3BCDF065A15B7B4638.jpg',
  'D3E4C35C9B1DA1C95AA355F2A439D984.png',
  'D54A4BD58E1C251D2C09B23FBA9D04EA.png',
  'D63B8CDBBD8DCFA6B38F0A109A4D39C7.jpg',
  'D64A3BC60AD893497BB246B56ED5ACBF.jpg',
  'D6D39E2ECE6807DC606ABA1166C4D555.jpg',
  'D72815AEAA4FBB32B5E23FA0A455A367.png',
  'D7ADBFF587E93F890DDE0558F909324C.jpg',
  'D7F3FA235EA9EB2DFF33DB7F7210296A.jpg',
  'D971D937AFED80848EE17459CD2C1E58.jpg',
  'DAD3B322B403337277922DD9159F8CA2.png',
  'DD00CD436C426E2085B67A84B4C1F045.jpg',
  'DD893DB2EBBB1AE43BC3FEBD791F12F1.jpg',
  'DE2CB965B096AEA306E8750CF2D3FC54.png',
  'DE2DE373C47A137DD678038AA71CD80F.jpg',
  'DEBA75698A1803CC75181C6C05783775.png',
  'E22A4AD4E812EB899EB5269FAE29B773.jpg',
  'E44DDF5983DBEAE0266203698913C49F.jpg',
  'E56923C6AF127C46891F1167DF24C790.jpg',
  'E7B9A51FE08EFDE8C57BAB4AF13D8B4E.jpg',
  'E7BBA51BCCB73266644A61B0CC081376.png',
  'F28CB5408AB9A3DD46BF6E4B72990AF9.jpg',
  'F2F3FE14EC5BCAFC8390665F294195CB.png',
  'F37B2D6C6B85CB0F0EEA649EC86C0137.jpg',
  'F4BA2AE7B5ABADBB57DB8E8A9FD59DD7.jpg',
  'F8B5C91F45D0EDA2A86E172660DFE96F.jpg',
  'FAE600094FE8E57A1FBF4D6BF606994B.png',
  'FB0DDC5F7C82751CA6D3CD7B969B4368.png',
  'FD4861043D799649D43209F87760BD08.png',
  'FDFE6006877A9A33C723831AB931C5A6.jpg',
]

/**
 * 返回随机图片文件名
 */
function pickRandom() {
  return IMAGES[Math.floor(Math.random() * IMAGES.length)]
}

/**
 * 构建 CORS 响应头
 */
function corsHeaders() {
  return {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type',
  }
}

/**
 * EdgeOne Pages Functions 入口
 * @param {EventContext} context
 */
export async function onRequest(context) {
  const { request } = context
  const url = new URL(request.url)
  const pathname = url.pathname

  // 处理预检请求
  if (request.method === 'OPTIONS') {
    return new Response(null, { status: 204, headers: corsHeaders() })
  }

  // GET /random → 302 重定向到随机图片
  if (pathname === '/random') {
    const file = pickRandom()
    const imageUrl = new URL(`/img/${file}`, request.url).toString()
    return Response.redirect(imageUrl, 302)
  }

  // GET /random/json → 返回随机图片 JSON 信息
  if (pathname === '/random/json') {
    const file = pickRandom()
    return new Response(
      JSON.stringify({
        url: `/img/${file}`,
        filename: file,
        total: IMAGES.length,
      }),
      {
        status: 200,
        headers: {
          'Content-Type': 'application/json; charset=utf-8',
          ...corsHeaders(),
        },
      }
    )
  }

  // GET /list → 返回全部图片列表
  if (pathname === '/list') {
    return new Response(
      JSON.stringify({
        total: IMAGES.length,
        images: IMAGES.map((f) => ({ filename: f, url: `/img/${f}` })),
      }),
      {
        status: 200,
        headers: {
          'Content-Type': 'application/json; charset=utf-8',
          ...corsHeaders(),
        },
      }
    )
  }

  // 其余路径交由 Pages 静态资源处理
  return context.next()
}
